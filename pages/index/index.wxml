<view class="container">
  <!-- é¡¶éƒ¨æ“ä½œæ  -->
  <view class="header-bar">
    <button class="header-btn" bindtap="newChat">
      <text class="btn-icon">ğŸ’¬</text>
      <text class="btn-text">æ–°å¯¹è¯</text>
    </button>
    <button class="header-btn" bindtap="viewHistory">
      <text class="btn-icon">ğŸ“</text>
      <text class="btn-text">å†å²è®°å½•</text>
    </button>
  </view>

  <!-- èŠå¤©å†…å®¹åŒºåŸŸ -->
  <scroll-view 
    class="chat-scroll" 
    scroll-y="true" 
    scroll-into-view="{{scrollIntoView}}" 
    scroll-with-animation="true">
    
    <block wx:for="{{chatList}}" wx:key="id">
      <!-- åªæ˜¾ç¤ºééšè—æ¶ˆæ¯ -->
      <block wx:if="{{!item.hidden}}">
        <!-- æ¶ˆæ¯æ—¶é—´ -->
        <view class="time-stamp" wx:if="{{index === 0 || chatList[index].time !== chatList[index-1].time}}">
          {{item.time}}
        </view>

        <!-- æ¶ˆæ¯æ°”æ³¡ -->
        <view class="message-group {{item.role === 'user' ? 'user-group' : 'bot-group'}}" id="{{item.id}}">

          <!-- æœºå™¨äººå¤´åƒ -->
          <view class="avatar bot-avatar" wx:if="{{item.role !== 'user'}}">ğŸ¤–</view>

          <!-- æ¶ˆæ¯å†…å®¹ -->
          <view class="bubble {{item.role === 'user' ? 'user-bubble' : 'bot-bubble'}}">
            <!-- æ˜¾ç¤ºå›¾ç‰‡ -->
            <view class="message-images" wx:if="{{item.images.length > 0}}">
              <image
                wx:for="{{item.images}}"
                wx:for-item="img"
                wx:key="*this"
                class="message-image"
                src="data:image/jpeg;base64,{{img}}"
                mode="widthFix"
                bindtap="previewImage"
                data-src="data:image/jpeg;base64,{{img}}"
              ></image>
            </view>

            <!-- æ˜¾ç¤ºæ–‡ä»¶ -->
            <view class="message-files" wx:if="{{item.files.length > 0}}">
              <view class="message-file" wx:for="{{item.files}}" wx:key="*this">
                <view class="file-icon">ğŸ“„</view>
                <view class="file-info">
                  <view class="file-name">{{item.name}}</view>
                  <view class="file-size">{{item.size}}</view>
                </view>
              </view>
            </view>

            <!-- æ˜¾ç¤ºæ–‡æœ¬å†…å®¹ -->
            <text user-select="true" wx:if="{{item.content && item.role === 'user'}}">{{item.content}}</text>
            <!-- ä½¿ç”¨towxmlæ¸²æŸ“AIå›å¤çš„ä»£ç å†…å®¹ -->
            <towxml wx:if="{{item.role === 'assistant' && item.towxmlData}}" nodes="{{item.towxmlData}}" />
            <text user-select="true" wx:if="{{item.role === 'system' && item.content}}">{{item.content}}</text>

          </view>

          <!-- ç”¨æˆ·å¤´åƒ -->
          <view class="avatar user-avatar" wx:if="{{item.role === 'user'}}">ğŸ‘¤</view>
        </view>
      </block>
    </block>

    <!-- Loading çŠ¶æ€ -->
    <view class="loading-wrap" wx:if="{{isLoading}}">
      <view class="loading-dots">
        <view class="dot"></view>
        <view class="dot"></view>
        <view class="dot"></view>
      </view>
      <text>æ€è€ƒä¸­...</text>
    </view>
    
    <!-- åº•éƒ¨å ä½ï¼Œé˜²æ­¢å†…å®¹è¢«è¾“å…¥æ¡†é®æŒ¡ -->
    <view style="height: 120rpx;"></view>
  </scroll-view>

  <!-- å¼¹å‡ºèœå• -->
  <view class="popup-menu" wx:if="{{showPopupMenu}}">
    <view class="popup-mask" bindtap="togglePopupMenu"></view>
    <view class="popup-content">
      <view class="popup-item" bindtap="chooseImage">
        <text class="popup-icon">ğŸ–¼ï¸</text>
        <text class="popup-text">ç›¸å†Œ</text>
      </view>
      <view class="popup-item" bindtap="chooseFile">
        <text class="popup-icon">ğŸ“„</text>
        <text class="popup-text">æ–‡æœ¬æ–‡ä»¶</text>
      </view>
      <view class="popup-item" bindtap="chooseAnyFile">
        <text class="popup-icon">ğŸ“‘</text>
        <text class="popup-text">æ–‡æ¡£è½¬å›¾ç‰‡</text>
      </view>
      <view class="popup-item" bindtap="chooseVideo">
        <text class="popup-icon">ğŸ¬</text>
        <text class="popup-text">è§†é¢‘åˆ†ç‰‡</text>
      </view>
      <view class="popup-item" bindtap="chooseAudioFile">
        <text class="popup-icon">ğŸµ</text>
        <text class="popup-text">éŸ³é¢‘è½¬æ–‡å­—</text>
      </view>
    </view>
  </view>

  <!-- åº•éƒ¨è¾“å…¥åŒºåŸŸ -->
  <view class="input-area">
    <!-- å·²é€‰æ‹©çš„å›¾ç‰‡é¢„è§ˆ -->
    <view class="selected-images" wx:if="{{selectedImages.length > 0}}">
      <view class="selected-image-container" wx:for="{{selectedImages}}" wx:key="*this">
        <image 
          class="selected-image" 
          src="data:image/jpeg;base64,{{item}}" 
          mode="aspectFill"
        ></image>
        <view class="remove-image" bindtap="removeImage" data-index="{{index}}">Ã—</view>
      </view>
    </view>
    
    <!-- å·²é€‰æ‹©çš„æ–‡ä»¶é¢„è§ˆ -->
    <view class="selected-files" wx:if="{{selectedFiles.length > 0}}">
      <view class="selected-file-container" wx:for="{{selectedFiles}}" wx:key="*this">
        <view class="file-icon">ğŸ“„</view>
        <view class="file-info">
          <view class="file-name">{{item.name}}</view>
          <view class="file-size">{{item.size}}</view>
        </view>
        <view class="remove-file" bindtap="removeFile" data-index="{{index}}">Ã—</view>
      </view>
    </view>
    
    <view class="input-row">
      <button class="plus-btn" bindtap="togglePopupMenu" disabled="{{isLoading}}">
        +
      </button>
      <input
        class="input-box" 
        type="text" 
        confirm-type="send"
        value="{{inputValue}}" 
        bindinput="handleInput" 
        bindconfirm="sendMessage"
        placeholder="è¾“å…¥æ¶ˆæ¯..." 
        disabled="{{isLoading}}"
      />
      <button 
        class="send-btn {{(inputValue.length > 0 || selectedImages.length > 0 || selectedFiles.length > 0) ? 'active' : ''}}" 
        bindtap="sendMessage" 
        disabled="{{(!inputValue && selectedImages.length === 0 && selectedFiles.length === 0) || isLoading}}">
        å‘é€
      </button>
    </view>
  </view>
  <!-- è¯­è¨€é€‰æ‹©å¼¹çª— -->
  <view class="modal-mask" wx:if="{{showLanguageModal}}">
    <view class="modal-container">
      <view class="modal-header">
        <text class="modal-title">é€‰æ‹©éŸ³é¢‘è¯­è¨€</text>
      </view>

      <view class="modal-body">
        <!-- å¸¸ç”¨è¯­è¨€ -->
        <view class="language-list">
          <block wx:for="{{commonLanguages}}" wx:key="code">
            <view
                    class="language-item {{selectedLanguage === item.code ? 'selected' : ''}}"
                    bindtap="selectLanguage"
                    data-language="{{item.code}}"
            >
              <text>{{item.name}}</text>
              <icon wx:if="{{selectedLanguage === item.code}}" type="success" size="20"></icon>
            </view>
          </block>

          <!-- å±•å¼€/æ”¶èµ·å…¨éƒ¨è¯­è¨€æŒ‰é’® -->
          <view class="toggle-all" bindtap="toggleAllLanguages">
            <text>{{showAllLanguages ? 'æ”¶èµ·' : 'æŸ¥çœ‹å…¨éƒ¨è¯­è¨€'}}</text>
            <icon type="{{showAllLanguages ? 'arrow-up' : 'arrow-down'}}" size="16"></icon>
          </view>

          <!-- å…¨éƒ¨è¯­è¨€åˆ—è¡¨ -->
          <block wx:if="{{showAllLanguages}}" wx:for="{{allLanguages}}" wx:key="code">
            <view
                    class="language-item {{selectedLanguage === item.code ? 'selected' : ''}}"
                    bindtap="selectLanguage"
                    data-language="{{item.code}}"
            >
              <text>{{item.name}}</text>
              <icon wx:if="{{selectedLanguage === item.code}}" type="success" size="20"></icon>
            </view>
          </block>
        </view>
      </view>

      <view class="modal-footer">
        <button class="modal-cancel" bindtap="closeLanguageModal">å–æ¶ˆ</button>
        <button class="modal-confirm" bindtap="confirmLanguage">ç¡®è®¤</button>
      </view>
    </view>
  </view>

</view>
